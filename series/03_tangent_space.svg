<svg viewBox="0 0 960 600" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowBlack" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#333333" />
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#e74c3c" />
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#27ae60" />
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#e67e22" />
    </marker>
    
    <radialGradient id="sphereGrad" cx="30%" cy="30%" r="70%">
      <stop offset="0%" style="stop-color:#f0f8ff;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#d6eaf8;stop-opacity:1" />
    </radialGradient>
    
    <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
      <feOffset dx="1" dy="1" result="offsetblur"/>
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.3"/>
      </feComponentTransfer>
      <feMerge> 
        <feMergeNode/>
        <feMergeNode in="SourceGraphic"/> 
      </feMerge>
    </filter>
  </defs>

  <rect width="960" height="600" fill="#ffffff" />
  
  <text x="40" y="50" font-family="'Helvetica Neue', Arial, sans-serif" font-size="28" font-weight="bold" fill="#2c3e50">球面上の最適化と接空間 (Tangent Space)</text>

  <g transform="translate(250, 340)">
    
    <path d="M -80,-230 L 220,-130 L 160,110 L -140,10 Z" fill="#3498db" fill-opacity="0.15" stroke="#3498db" stroke-width="1" stroke-dasharray="4,4"/>
    <text x="-120" y="-10" font-family="Arial, sans-serif" font-size="16" fill="#2980b9" font-weight="bold">TxS</text>
    
    <circle cx="0" cy="0" r="160" fill="url(#sphereGrad)" stroke="#bdc3c7" stroke-width="2"/>
    <ellipse cx="0" cy="0" rx="160" ry="60" fill="none" stroke="#bdc3c7" stroke-width="1" stroke-dasharray="5,3" opacity="0.6"/>
    <path d="M 0,-160 Q 60,0 0,160" fill="none" stroke="#bdc3c7" stroke-width="1" stroke-dasharray="5,3" opacity="0.6"/>

    <line x1="0" y1="0" x2="96" y2="-96" stroke="#7f8c8d" stroke-width="2" stroke-dasharray="4,4"/>
    <text x="-15" y="15" font-family="Arial, sans-serif" font-size="14" fill="#7f8c8d">O</text>

    <circle cx="96" cy="-96" r="6" fill="#2c3e50" stroke="white" stroke-width="2"/>
    <text x="85" y="-110" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#2c3e50">x</text>

    <line x1="96" y1="-96" x2="136" y2="-136" stroke="#e67e22" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
    <text x="145" y="-120" font-family="Arial, sans-serif" font-size="14" fill="#d35400" font-weight="bold">法線成分</text>
    
    <line x1="96" y1="-96" x2="180" y2="-40" stroke="#27ae60" stroke-width="4" marker-end="url(#arrowGreen)"/>
    <text x="190" y="-30" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#27ae60">grad f(x)</text>
    <text x="190" y="-10" font-family="Arial, sans-serif" font-size="12" fill="#27ae60">リーマン勾配</text>

    <line x1="96" y1="-96" x2="220" y2="-80" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowRed)"/>
    <text x="230" y="-85" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#e74c3c">∇f(x)</text>
    <text x="230" y="-65" font-family="Arial, sans-serif" font-size="12" fill="#e74c3c">ユークリッド勾配</text>
    
    <line x1="180" y1="-40" x2="220" y2="-80" stroke="#95a5a6" stroke-width="1" stroke-dasharray="3,3"/>
    <line x1="136" y1="-136" x2="220" y2="-80" stroke="#95a5a6" stroke-width="1" stroke-dasharray="3,3"/>
    
    <path d="M 108,-108 L 115,-101 L 103,-89" fill="none" stroke="#7f8c8d" stroke-width="1.5"/>

  </g>

  <g transform="translate(520, 100)">
    
    <rect x="0" y="0" width="400" height="200" rx="10" fill="#f8f9fa" stroke="#e1e4e8" stroke-width="1"/>
    <text x="20" y="40" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#2c3e50">1. 接空間と勾配の定義</text>
    
    <foreignObject x="20" y="60" width="360" height="120">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-family: 'Times New Roman', serif; font-size: 16px; color: #34495e;">
        <div style="margin-bottom: 12px;">
          <span style="font-weight:bold; color:#2980b9">接空間 (Tangent Space):</span><br/>
          ベクトル $v$ が $x$ と直交する空間<br/>
          $T_x S = \{ v \in \mathbb{R}^d \mid v^\top x = 0 \}$
        </div>
        <div>
          <span style="font-weight:bold; color:#27ae60">リーマン勾配 (Riemannian Grad):</span><br/>
          ユークリッド勾配を接空間へ射影<br/>
          $\text{grad} f(x) = (I - xx^\top) \nabla f(x)$
        </div>
      </div>
    </foreignObject>

    <g transform="translate(0, 230)">
      <rect x="0" y="0" width="400" height="180" rx="10" fill="#fffbe6" stroke="#f39c12" stroke-width="1" stroke-opacity="0.3"/>
      <text x="20" y="35" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#d35400">2. 更新アルゴリズム (Retraction)</text>
      
      <g transform="translate(60, 100)">
        <path d="M -40,40 Q 0,0 40,-10" fill="none" stroke="#bdc3c7" stroke-width="2"/>
        <text x="-50" y="55" font-family="Arial, sans-serif" font-size="12" fill="#7f8c8d">球面 S</text>

        <circle cx="0" cy="15" r="4" fill="#2c3e50"/>
        <text x="-15" y="10" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#2c3e50">x<tspan dy="3" font-size="10">t</tspan></text>

        <line x1="0" y1="15" x2="80" y2="-15" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowRed)"/>
        <text x="20" y="-5" font-family="Arial, sans-serif" font-size="12" fill="#e74c3c" font-weight="bold">-η∇f</text>
        
        <circle cx="80" cy="-15" r="3" fill="#e74c3c" opacity="0.6"/>
        <text x="85" y="-15" font-family="Arial, sans-serif" font-size="14" fill="#e74c3c">y</text>

        <line x1="80" y1="-15" x2="60" y2="28" stroke="#27ae60" stroke-width="2" stroke-dasharray="3,2" marker-end="url(#arrowGreen)"/>
        <text x="85" y="15" font-family="Arial, sans-serif" font-size="12" fill="#27ae60" font-weight="bold">正規化</text>
        <text x="85" y="30" font-family="Arial, sans-serif" font-size="11" fill="#27ae60">y / ||y||</text>

        <circle cx="60" cy="28" r="4" fill="#27ae60"/>
         <text x="50" y="50" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#27ae60">x<tspan dy="3" font-size="10">t+1</tspan></text>
         
         <path d="M 40,-10 Q 60,-15 80,-10" fill="none" stroke="#bdc3c7" stroke-width="2" stroke-dasharray="2,2" opacity="0.5"/>
         <path d="M 40,-10 Q 55,20 60,28" fill="none" stroke="#bdc3c7" stroke-width="2" opacity="0.5"/>
      </g>
      
      <foreignObject x="200" y="50" width="180" height="120">
         <div xmlns="http://www.w3.org/1999/xhtml" style="font-family: Arial, sans-serif; font-size: 13px; color: #555;">
          <ol style="padding-left: 20px; margin-top:0;">
            <li style="margin-bottom:8px;">
              <strong style="color:#e74c3c">接空間方向へ移動</strong><br/>
              (または通常の勾配更新)
            </li>
            <li>
              <strong style="color:#27ae60">球面上へ引き戻す</strong><br/>
              (Retraction / 正規化)
            </li>
          </ol>
        </div>
      </foreignObject>
    </g>
  </g>
</svg>
