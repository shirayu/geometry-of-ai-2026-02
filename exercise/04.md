# 第4回：分類の再統一 I

## 問題 4-1 ★ Softmaxの温度パラメータ

Softmax関数の温度パラメータ $\tau$ を0.1, 1.0, 10.0と変化させたとき、出力分布がどう変わるか、具体的なlogit [2.0, 1.0, 0.1] で計算せよ。

**ヒント:** $\text{softmax}(z/\tau)$ を計算する。

**解答:**

```04_softmax_temperature.py
import numpy as np


def softmax(z, tau):
    z_scaled = z / tau
    exp_z = np.exp(z_scaled - np.max(z_scaled))  # 数値安定化
    return exp_z / np.sum(exp_z)


logits = np.array([2.0, 1.0, 0.1])

for tau in [0.1, 1.0, 10.0]:
    probs = softmax(logits, tau)
    print(f"τ={tau:4.1f}: {probs.round(4)}")
```

**出力:**

```text
τ= 0.1: [1.     0.     0.    ]  # ほぼone-hot（argmax的）
τ= 1.0: [0.659  0.242  0.099 ]  # 標準的な分布
τ=10.0: [0.381  0.341  0.278 ]  # ほぼ一様に近づく
```

**解釈:** $\tau \to 0$ で「最も高いlogitに全確率」、 $\tau \to \infty$ で「一様分布」に近づく。 $\tau$ は「確信度の調整つまみ」。

## 問題 4-2 ★★ Gumbel-Softmaxの仕組み

Gumbel-Softmaxが「微分可能なargmax」として機能する理由を、幾何学的に説明せよ。

**ヒント:** シンプレックス内部での確率的な「揺らぎ」と、 $\tau \to 0$ での振る舞いを考えよ。

**解答:**
**通常のargmaxの問題:** argmaxは離散的で微分不可能。シンプレックスの頂点への「ジャンプ」であり、勾配が定義できない。

**Gumbel-Softmaxの解決策:**

1. Gumbelノイズを加えることで、logitにランダムな摂動を与える
2. この摂動により、シンプレックス内部のさまざまな点がサンプリングされる
3. $\tau$ を小さくすると、サンプルは頂点に近づく（one-hotに近づく）
4. 勾配計算時には、Softmaxの連続緩和として微分可能な形で近似する

**幾何学的解釈:** シンプレックス内部で「確率的に揺らぎながら」頂点に向かう軌跡。 $\tau$ はこの軌跡の「ぼやけ具合」を制御する。 $\tau \to 0$ で軌跡は頂点に収束し、離散的なargmaxに近づく。

**注意:** $\tau$ を極端に小さくすると勾配が不安定になったり、勾配の大きさが減衰することがある。実用上は適切な $\tau$ の選択が重要。

## 問題 4-3 ★★★ Top-pサンプリングの幾何学

LLMの出力層で、Top-pサンプリング（nucleus sampling）を使うことの幾何学的意味を考察せよ。

**ヒント:** シンプレックス上で「どの領域から」サンプリングしているか？

**解答:**
**Top-pサンプリング:** 確率の高い順にトークンを並べ、累積確率がpを超えるまでのトークン集合からサンプリングする。

**幾何学的解釈:**

- Softmax出力はシンプレックス内部の点
- Top-pは、この点の周りの「高確率領域」のみを使う
- 具体的には、シンプレックスの特定の頂点群に近い「部分領域」に制限してサンプリング

**効果:**

- 低確率の「尾」を切り捨てることで、意味不明なトークンの出現を防ぐ
- しかしargmaxと違い、高確率トークン間の多様性は保持
- 「シンプレックスの頂点近傍」ではなく「確率質量の大部分を含む部分シンプレックス」からサンプリング

**比較:** 温度 $\tau$ の調整が「シンプレックス全体での分布の鋭さ」を変えるのに対し、Top-pは「サンプリング領域自体を制限」する。
